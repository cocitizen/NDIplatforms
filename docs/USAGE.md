NDI PLATFORMS
=============

This document describes building platforms using the NDIplatforms stub Drush
makefiles.  To understand how these makefiles are maintained, please see
docs/MAINTENANCE.md.


USAGE
-----

For simplicity, we use the (hypothetical) "stubs/ndi-polls.make" makefile in
our examples.  Obviously, replace this with whichever platform stub makefile
is appropriate.

To build a platform (also referred to as a code-base), we use Drush make along
with our lockfiles.  A lockfile is simply a type of makefile generated by Drush,
that specifies all the versions for all the included projects.

In order to be able to build the same platform in a repeatable fashion, we use
lockfiles, since they are fully specified.  Also, this allows us to build plat-
forms using the lockfiles remotely, without having to be concerned with any
includes being specified locally.  For example, we can use the raw output of a
git repository containing such a lockfile, and be confident that the platform
that is built will be identical to one built right after that commit.


Build a platform on the command-line
------------------------------------

We start by simply calling Drush make (usually as the "aegir" user):

    $ drush make ~/makefiles/NDIplatforms/locks/ndi-polls.lock.yml ~/platforms/DemTools_2015-10-21

Assuming that the platform build worked, we need to tell Aegir about it.
The easiest way to do that is to visit /node/add/platform on the Aegir site.
We then need to provide a name, such as "DemTools_2015-10-21", and specify
the path where we built it.

This can also be accomplished at the command-line by running the provision-save
and hosting-import Drush commands provided by Aegir.  However, this is a very
advanced technique which we will not cover here.  Use the "--help" option with
these commands to see how they work.


Build a platform in the Aegir UI
--------------------------------

Alternatively, we can build the platform directly from within the Aegir UI.
This is the preferred method, as it:

  * makes the output of the platform build available in the task log;
  * creates a link to the makefile that was used in building the platform; and
  * avoids having to import the platform separately.

However, some YAML makefiles require Drush 8, which only shipped with Aegir
Debian packages starting in version 3.4. As a result, building fro the command
line may be required, if you are using an older version.

First, find the lockfile we want to use to build the platform on Github, such
as https://github.com/nditech/NDIplatforms/blob/master/locks/ndi-polls.lock.yml.
Then click the "Raw" button to get a link to the output that Drush Make can
accept.  Copy that URL into the "makefile" field on "/node/add/platform" on the
Aegir site.  Then provide a meaningful name, such as "DemTools_2015-10-21", and
click "Save".

That should be all that is required.  In the background, Aegir will download the
makefile, run Drush Make, and register the platform.  You should see a link to
the makefile used in creating the platform.  This is useful to determine the
exact platform contents, or for re-creating the platform elsewhere, such as on
a different server.

