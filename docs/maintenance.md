MAINTENANCE [![Build status](https://travis-ci.org/nditech/NDIplatforms.svg)](https://travis-ci.org/nditech/NDIplatforms)
===========

This section describes how to maintain Drush Make lockfiles. To understand how
to build platforms using them, please see the [Usage](usage.md) section. To
better understand how these makefiles are structured, please see the
[Structure](structure.md) section.

Please follow the installation instructions in the [Install](install.md)
section, as we currently recommend using a git version of Drush. The usage
instructions below assume that you have followed those instructions exactly.

For simplicity, we use the "demtools/dkan" project in our examples. Obviously,
replace this with whichever platform is appropriate.


Drush Make lockfiles
--------------------

The principle benefit of using lockfiles, over regular makefiles, is that they
allow us to build the same platform in a repeatable fashion. A lockfile is
simply a type of makefile generated by Drush, that specifies all the versions
for all the included projects. Otherwise, we might get a different platform
each time we build, depending on how many projects we include, their release
cycle and/or the pace of their development.

Also, lockfiles allow us to build platforms using the lockfiles remotely,
without having to be concerned with any includes being specified locally. For
example, we can use the raw output of a git repository containing such a
lockfile, and be confident that any subseqent platform built with that same URL
will be identical.


Update your makefiles
---------------------

First, we create a temporary lockfile based on a given platform stub:

    $ drush7 make --no-build --lock=/tmp/make.lock stubs/ndi-polls.make
    Wrote .make file /tmp/make.lock

Note: the --lock parameter does not work with the ~ path shortcut.

Then, we compare it to the current lockfile, so we can see what changes have
occurred:

    $ drush7 diff locks/ndi-polls.lock /tmp/make.lock --list=0
     Project  Old version  New version  Notices                            
     drupal   7.38         7.39         version upgraded, patches changed.

Investigate and fix any warnings as appropriate.  This will generally involve
pinning a version for a module.  This is done by commenting out the module from
the general modules list (i.e., includes/modules.make), then adding an entry
in the modules pin list (e.g., includes/modules-pins.make):

    ; The recommended release is on the 2.x branch, so we pin to the latest
    ; supported version on the 1.x branch.
    ; For updates, check: https://drupal.org/project/google_analytics
    projects[goole_analytics][version] = 1

It is usually best to pin to a major version in this case, so that new releases
on that branch are incorporated automatically.

Re-running the commands above should now no longer show any major version
upgrade warnings.


Test the new lockfile
---------------------

It is usually worthwhile to test the new lockfile at this point. For example,
an update to a module could cause a patch to no longer apply. Usually, in such
cases, updating the makefile with a new patch, or simply removing patches that
have been incorporated into the new release, will be sufficient to resolve any
issues at this stage.

Adding or changing patches or libraries, adding new modules or themes, and
other such modifications can also cause build failures. Running a test build is
as simple as running drush make on the new lockfile:

    $ drush7 make /tmp/make.lock test_demtools


Finalize the new lockfile
-------------------------

Once all changes and warnings are resolved or accepted, and documented, we copy
the temporary lockfile over the existing one in our repo:

    $ cp /tmp/make.lock locks/ndi-polls.lock

Then commit these changes into git:

    $ git commit -am"Update NDI's common platform."

It may also be useful to include the output of "drush make-diff" in the commit
message.

