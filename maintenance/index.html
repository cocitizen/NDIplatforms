<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Maintenance - NDIplatforms</title>
  

  <link rel="shortcut icon" href="../_images/favicon.ico">
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="../_css/menu.css" rel="stylesheet">
  <link href="../_css/term.css" rel="stylesheet">
  <link href="../_css/style.css" rel="stylesheet">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Maintenance";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> NDIplatforms</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Home</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../install/">Install</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../usage/">Usage</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../structure/">Structure</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">Maintenance</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#maintenance">MAINTENANCE</a></li>
                
                    <li><a class="toctree-l4" href="#drush-make-lockfiles">Drush Make lockfiles</a></li>
                
                    <li><a class="toctree-l4" href="#update-your-makefiles">Update your makefiles</a></li>
                
                    <li><a class="toctree-l4" href="#update-the-lockfiles">Update the lockfiles</a></li>
                
                    <li><a class="toctree-l4" href="#test-the-new-lockfile">Test the new lockfile</a></li>
                
                    <li><a class="toctree-l4" href="#finalize-the-new-lockfile">Finalize the new lockfile</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../documentation/">Documentation</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">NDIplatforms</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Maintenance</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/NDItech/NDIplatforms" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="maintenance">MAINTENANCE <a href="https://travis-ci.org/nditech/NDIplatforms"><img alt="Build status" src="https://travis-ci.org/nditech/NDIplatforms.svg" /></a></h1>
<p>This section describes how to maintain Drush Make lockfiles. To understand how
to build platforms using them, please see the <a href="../usage/">Usage</a> section. To
better understand how these makefiles are structured, please see the
<a href="../structure/">Structure</a> section.</p>
<p>Please follow the installation instructions in the <a href="../install/">Install</a>
section, as we currently recommend using a git version of Drush. The usage
instructions below assume that you have followed those instructions exactly.</p>
<p>For simplicity, we use the "demtools/dkan" project (unless otherwis specified)
in our examples. Obviously, replace this with whichever platform is
appropriate.</p>
<h3 id="drush-make-lockfiles">Drush Make lockfiles</h3>
<p>The principle benefit of using lockfiles, over regular makefiles, is that they
allow us to build the same platform in a repeatable fashion. A lockfile is
simply a type of makefile generated by Drush, that specifies all the versions
for all the included projects. Otherwise, we might get a different platform
each time we build, depending on how many projects we include, their release
cycle and/or the pace of their development.</p>
<p>Also, lockfiles allow us to build platforms using the lockfiles remotely,
without having to be concerned with any includes being specified locally. For
example, we can use the raw output of a git repository containing such a
lockfile, and be confident that any subseqent platform built with that same URL
will be identical.</p>
<h2 id="update-your-makefiles">Update your makefiles</h2>
<p>Under normal circumstances, you'll only need to modify makefiles to add or
remove components from your platform build. Some (very few) makefiles require
manual updates to version numbers. The only use-case we are currently aware of
is when downloading a project or library using the <code>get</code> download type. An
example of this can be seen in <code>makefiles/stock/civicrm/contrib.make.yml</code>:</p>
<pre class="codehilite"><code class="language-yaml">projects:
  civicrm:
    type: module
    download:
      type: get
      url: 'http://downloads.sourceforge.net/project/civicrm/civicrm-stable/4.6.13/civicrm-4.6.13-drupal.tar.gz'</code></pre>


<p>We can see the result of updating a makefile by building our lockfiles with
<code>make all</code> and <code>git diff</code>. But that is covered in more detail in the next section.</p>
<h3 id="pinning-major-versions">Pinning major versions</h3>
<p>Occasionally we'll see a new major version of a project released. By default,
Drush Make will select the most recent supported version of a project. As a
result, our lockfiles would show a major version bump as well. Generally
speaking, major version upgrades of modules are not a part of the day-to-day
maintenance of platforms. They will likely require some manual intervention,
or, at very least, thorough testing.</p>
<p>Assuming the current version of such a component is still supported, the most
expedient solution is likely to involve pinning a major version for the module.
This allows new releases on that branch to be incorporated automatically.</p>
<p>For example, in <code>makefiles/demtools/civicrm/contrib.make.yml</code>, we could replace
this:</p>
<pre class="codehilite"><code class="language-yaml">projects:
  webform:  { version: ~ }</code></pre>


<p>With the following:</p>
<pre class="codehilite"><code class="language-yaml">projects:
  webform:
    # The recommended release is on the 4.x branch, so we pin to the latest
    # supported version on the 3.x branch.
    version: 3</code></pre>


<p>Note that it is usually worthwhile to document the reasons for such pinning.
Rebuild the lockfiles, and check what has changed:</p>
<pre class="codehilite"><code class="language-console">$ make all
tmp/drush make-lock makefiles/demtools/civicrm/build.yml --result-file=makefiles/demtools/civicrm/lock.yml
Wrote .make file makefiles/demtools/civicrm/lock.yml                                                                       [ok]
$ git diff makefiles/demtools/civicrm/lock.yml</code></pre>


<p>The resulting diff should show something like this:</p>
<pre class="codehilite"><code class="language-git-diff">diff --git a/makefiles/demtools/civicrm/lock.yml b/makefiles/demtools/civicrm/lock.yml
index d3ab256..212a373 100644
--- a/makefiles/demtools/civicrm/lock.yml
+++ b/makefiles/demtools/civicrm/lock.yml
@@ -58,7 +58,7 @@ projects:
   webform_civicrm:
     version: '4.15'
   webform:
-    version: '4.12'
+    version: '3.24'
   libraries:
     version: '2.2'
   options_element:</code></pre>


<h2 id="update-the-lockfiles">Update the lockfiles</h2>
<p>We use a GNU Makefile to simplify updates to lockfiles. This Makefile defines
dependencies between the various lockfiles, and their includes. This means that
when a (Drush) makefile is updated, all lockfiles that include that makefile
will be rebuilt.</p>
<p>Since we keep all our lockfiles in git, it's often easiest to simply force the
re-compilation of all the lockfiles:</p>
<pre class="codehilite"><code class="language-console">$ make all -B
tmp/drush make-lock makefiles/cores/drupal7/build.yml --result-file=makefiles/cores/drupal7/lock.yml
Wrote .make file makefiles/cores/drupal7/lock.yml                                                                          [ok]
tmp/drush make-lock makefiles/cores/drupal8/build.yml --result-file=makefiles/cores/drupal8/lock.yml
Wrote .make file makefiles/cores/drupal8/lock.yml                                                                          [ok]
tmp/drush make-lock makefiles/stock/dkan/build.yml --result-file=makefiles/stock/dkan/lock.yml
Wrote .make file makefiles/stock/dkan/lock.yml                                                                             [ok]
tmp/drush make-lock makefiles/stock/civicrm/build.yml --result-file=makefiles/stock/civicrm/lock.yml
Wrote .make file makefiles/stock/civicrm/lock.yml                                                                          [ok]
tmp/drush make-lock makefiles/demtools/dkan/build.yml --result-file=makefiles/demtools/dkan/lock.yml
Wrote .make file makefiles/demtools/dkan/lock.yml                                                                          [ok]
tmp/drush make-lock makefiles/demtools/civicrm/build.yml --result-file=makefiles/demtools/civicrm/lock.yml
Wrote .make file makefiles/demtools/civicrm/lock.yml                                                                       [ok]</code></pre>


<p>A quick <code>git diff</code> will then show any updates to lockfiles.</p>
<p>This behaviour is based on file timestamps, even if the contents have not changed. To see it in action, you can test it with:</p>
<pre class="codehilite"><code class="language-console">$ touch makefiles/stock/dkan/contrib.make.yml
$ make all
tmp/drush make-lock makefiles/stock/dkan/build.yml --result-file=makefiles/stock/dkan/lock.yml
Wrote .make file makefiles/stock/dkan/lock.yml                                                                             [ok]
tmp/drush make-lock makefiles/demtools/dkan/build.yml --result-file=makefiles/demtools/dkan/lock.yml
Wrote .make file makefiles/demtools/dkan/lock.yml                                                                          [ok]</code></pre>


<p>As you can see, updating the timestamp on a single file, triggered updates to
the two lockfiles that include it. In fact, only
<code>makefiles/stock/dkan/lock.yml</code> depends directly on
<code>makefiles/stock/dkan/contrib.make.yml</code>. The <code>demtools/dkan</code> lockfile depends
on the stock dkan lockfile, and so is rebuilt when that one is updated.</p>
<h2 id="test-the-new-lockfile">Test the new lockfile</h2>
<p>It is usually worthwhile to test the new lockfile at this point. For example,
an update to a module could cause a patch to no longer apply. Usually, in such
cases, updating the makefile with a new patch, or simply removing patches that
have been incorporated into the new release, will be sufficient to resolve any
issues at this stage.</p>
<p>Adding or changing patches or libraries, adding new modules or themes, and
other such modifications can also cause build failures. Running a test build is
as simple as running:</p>
<pre class="codehilite"><code class="language-console">$ make demtools/dkan-test
Beginning to build makefiles/demtools/dkan/lock.yml.           [ok]
drupal-7.43 downloaded.                                        [ok]
[...]</code></pre>


<p>Each DemTools platform (demtools/dkan, demtools/civicrm, etc.) have such a test
command defined (although it may not show up in the <code>make list</code> output).</p>
<p>Note that running such a test will re-compile any relevant lockfiles whose
sources have changed.</p>
<h2 id="finalize-the-new-lockfile">Finalize the new lockfile</h2>
<p>Once any changes or updates are done, we can then commit these changes into git:</p>
<pre class="codehilite"><code class="language-console">$ git commit -am&quot;Update DemTools platforms.&quot;</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../documentation/" class="btn btn-neutral float-right" title="Documentation"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../structure/" class="btn btn-neutral" title="Structure"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../structure/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../documentation/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
